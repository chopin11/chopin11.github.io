<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="no-referrer-when-downgrade">
  
  <meta name="baidu-site-verification" content="" />
  <meta name="google-site-verification" content="" />
  <meta name="msvalidate.01" content="" />
  <meta name="360-site-verification" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- if page has tags, then add tags to keyword -->
  
  
  <meta name="keywords" content="肖邦,肖邦Linux,tcpdump,Go语言,golang,python,负载均衡,lvs,lvs,lb,负载均衡,高性能">
  <!-- page.description has higher priority -->
  <meta name="description" content="本文主要从内核数据包是如何流动的方向出发，来介绍负载均衡 LVS 的基本工作原理。">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <title>
    
    负载均衡 LVS 基本原理 | 肖邦Linux
    
  </title>

  <link rel="canonical" href="https://www.tcpdump.cn/post/1970613528.html">
  
<link rel="stylesheet" href="/css/geektutu.css">

  <!-- global function -->
  <script>
    window.globalAddScript = function (url, onload, onerror) {
      var s = document.createElement('script');
      s.src = url;
      onload && (s.onload = onload);
      onerror && (s.onerror = onerror);
      document.body.appendChild(s);
    }
    window.globalAddCss = function (url) {
      var s = document.createElement('link');
      s.rel = 'stylesheet';
      s.href = url;
      document.body.appendChild(s);
    }
    window.getPosition = function (ele) {
      var x = 0, y = 0;
      while (ele) {
        x += (ele.offsetLeft - ele.scrollLeft + ele.clientLeft);
        y += (ele.offsetTop - ele.scrollTop + ele.clientTop);
        ele = ele.offsetParent;
      }
      return { x: x, y: y };
    }
    window.getDom = function (str) { return document.querySelector(str) }
  </script>
  <!-- google ad -->
  
<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/feed.xml" title="肖邦Linux" type="application/rss+xml">
</head>

<body>
    
<header class="gkt-header col-xs-12 padding-0">
    <div id="gkt-nav" class="gkt-header-container">
        <a href="/" class="gkt-header-title float-left">
            <img class="float-left" src="/img/favicon.ico" alt="">
            <span>肖邦Linux</span>
        </a>
        <nav class="gkt-header-nav text-right">
            <ul>
                <li><a class="hidden-xs" href="/feed.xml">订阅</a></li>
                <li><a href="/series/">专题</a></li>
                <li><a href="/archives/">归档</a></li>
                <li><a href="/post/link.html">友链</a></li>
                <li><a href="/post/about.html">关于</a></li>
            </ul>
        </nav>
    </div>
    <div id="gkt-cate-nav" class="gkt-header-container hidden-xs">
        
        <nav class="gkt-header-nav float-left">
            <ul>
                
                
                <li class="gkt-cate-name float-left active">
                    <a class="float-left" href="/post/325553977.html">负载均衡</a>
                    
                </li>
                
                <li class="gkt-cate-name float-left ">
                    <a class="float-left" href="/post/1111606992.html">Linux基础</a>
                    
                </li>
                
                <li class="gkt-cate-name float-left ">
                    <a class="float-left" href="/post/78358564.html">HTTPS</a>
                    
                </li>
                
                <li class="gkt-cate-name float-left ">
                    <a class="float-left" href="/post/1335797944.html">网络协议</a>
                    
                </li>
                
                <li class="gkt-cate-name float-left ">
                    <a class="float-left" href="/post/1335797944.html">面试</a>
                    
                </li>
                
                <li class="gkt-cate-name float-left ">
                    <a class="float-left" href="/post/55249683.html">工具效率</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</header>
<div class="gkt-header-placeholder" style="height: 44px"></div>
<div class="gkt-header-placeholder hidden-xs" style="height: 44px"></div>
<script>
    (function () {
        window.addEventListener('scroll', function () {
            if (window.innerWidth < 768) {
                return;
            }
            var nav = document.querySelector('#gkt-nav');
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            scrollTop > 50 && (nav.classList.add('hide'));
            scrollTop <= 50 && (nav.classList.remove('hide'));
        });
        var cateNavs = document.querySelectorAll('#gkt-cate-nav>nav>ul>li');
        [].slice.call(cateNavs).forEach(function (item) {
            var sub = item.querySelector('.gkt-sub-cate');
            if (!sub) return;
            item.addEventListener('mouseenter', function (e) { sub.style.display = 'block'; }, false);
            item.addEventListener('mouseleave', function (e) { sub.style.display = 'none'; }, false);
        })
    })();
</script>
    <!-- Main Content -->
    <div class="main-container">
        <!-- Main Content -->
<main class="col-xs-12 padding-0 markdown-it">
    <!-- Post Container -->
    
    
    <!-- Post Content -->
<div class="float-left post-container box-shadow">
    <div class="u-arrow-wrapper hidden-xs">
        
        <a class="float-left" href="/post/2589298645.html"><i class="u-arrow-left"></i></a>
        
        
        <a class="float-right" href="/post/3671532823.html"><i class="u-arrow-right"></i></a>
        
    </div>
    <article class="col-xs-12">
        <h1> 负载均衡 LVS 基本原理 </h1>
        
        
        <div class="hidden-lg hidden-md series_links">
            <p> <strong> 负载均衡系列文章链接：</strong></p>
            <ul>
                
                <li>
                    <a href="/post/325553977.html">keepalived 快速入门介绍</a>
                    <span class="post-item-date">(Jan 2, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/2589298645.html">负载均衡 LVS 基本介绍</a>
                    <span class="post-item-date">(Feb 4, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/1970613528.html">负载均衡 LVS 基本原理</a>
                    <span class="post-item-date">(Mar 6, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/3671532823.html">负载均衡 LVS 操作实践</a>
                    <span class="post-item-date">(Apr 8, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/2126991808.html">负载均衡 LVS 连接表</a>
                    <span class="post-item-date">(May 10, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/522418658.html">负载均衡 LVS 调度算法</a>
                    <span class="post-item-date">(Jun 12, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/3360290171.html">负载均衡 LVS 主流程代码分析</a>
                    <span class="post-item-date">(Jul 14, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/1229090889.html">负载均衡 LVS TOA 实现原理</a>
                    <span class="post-item-date">(Aug 16, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/2778281555.html">负载均衡 DPVS SNAT 功能介绍</a>
                    <span class="post-item-date">(Sep 18, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/3989527185.html">负载均衡 DPVS 路由子系统的实现</a>
                    <span class="post-item-date">(Oct 20, 2021)</span>
                </li>
                
                <li>
                    <a href="/post/4205823097.html">负载均衡 DPVS 邻居子系统的实现</a>
                    <span class="post-item-date">(Nov 22, 2021)</span>
                </li>
                
            </ul>
        </div>
        
        
        <div class="gkt-article-start"></div>
        <blockquote>
<p>LVS 是由章文嵩博士开源的负载均衡系统，它现在是标准内核的一部分，它具备可靠性、高性能、可扩展性和可操作性，从而以低廉的成本实现最优的性能。</p>
</blockquote>
<h2 id="一、netfilter基本原理"><a href="#一、netfilter基本原理" class="headerlink" title="一、netfilter基本原理"></a>一、netfilter基本原理</h2><p>LVS 是基于 Linux 内核中 netfilter 框架实现的负载均衡系统，所以要学习 LVS 之前必须要先简单了解 netfilter 基本工作原理。netfilter 其实很复杂也很重要，平时我们说的 Linux 防火墙就是 netfilter，不过我们平时操作的都是 iptables，iptables 只是用户空间编写和传递规则的工具而已，真正工作的是 netfilter。通过下图可以简单了解下 netfilter 的工作机制：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chopin11/image001/lb003netfilter.png" alt="netfilter 基本原理图"></p>
<p>netfilter 是内核态的 Linux 防火墙机制，作为一个通用、抽象的框架，提供了一整套的 hook 函数管理机制，提供诸如数据包过滤、网络地址转换、基于协议类型的连接跟踪的功能。</p>
<p>通俗点讲，就是 netfilter 提供一种机制，可以在数据包流经过程中，根据规则设置若干个关卡（hook 函数）来执行相关的操作。netfilter 总共设置了 5 个点，包括：PREROUTING、INPUT、FORWARD、OUTPUT、POSTROUTING</p>
<ul>
<li><code>PREROUTING</code> ：刚刚进入网络层，还未进行路由查找的包，通过此处</li>
<li><code>INPUT</code> ：通过路由查找，确定发往本机的包，通过此处</li>
<li><code>FORWARD</code> ：经路由查找后，要转发的包，在POST_ROUTING之前</li>
<li><code>OUTPUT</code> ：从本机进程刚发出的包，通过此处</li>
<li><code>POSTROUTING</code> ：进入网络层已经经过路由查找，确定转发，将要离开本设备的包，通过此处</li>
</ul>
<p>当一个数据包进入网卡，经过链路层之后进入网络层就会到达 PREROUTING，接着根据目标 IP 地址进行路由查找，如果目标 IP 是本机，数据包继续传递到 INPUT 上，经过协议栈后根据端口将数据送到相应的应用程序；应用程序处理请求后将响应数据包发送到 OUTPUT 上，最终通过 POSTROUTING 后发送出网卡。如果目标 IP 不是本机，而且服务器开启了 forward 参数，就会将数据包递送给 FORWARD 上，最后通过 POSTROUTING 后发送出网卡。</p>
<h2 id="二、LVS基本原理"><a href="#二、LVS基本原理" class="headerlink" title="二、LVS基本原理"></a>二、LVS基本原理</h2><p>LVS 是基于 netfilter 框架，主要工作于 INPUT 链上，在 INPUT 上注册 <code>ip_vs_in</code> HOOK 函数，进行 IPVS 主流程，大概原理如图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chopin11/image001/lb004ipvs.png" alt="LVS 基本原理图"></p>
<ul>
<li>当用户访问 <a target="_blank" rel="noopener" href="http://www.sina.com.cn/">www.sina.com.cn</a> 时，用户数据通过层层网络，最后通过交换机进入 LVS 服务器网卡，并进入内核网络层。</li>
<li>进入 PREROUTING 后经过路由查找，确定访问的目的 VIP 是本机 IP 地址，所以数据包进入到 INPUT 链上</li>
<li>IPVS 是工作在 INPUT 链上，会根据访问的 <code>vip+port</code> 判断请求是否 IPVS 服务，如果是则调用注册的 IPVS HOOK 函数，进行 IPVS 相关主流程，强行修改数据包的相关数据，并将数据包发往 POSTROUTING 链上。</li>
<li>POSTROUTING 上收到数据包后，根据目标 IP 地址（后端服务器），通过路由选路，将数据包最终发往后端的服务器上。</li>
</ul>
<p>开源 LVS 版本有 3 种工作模式，每种模式工作原理截然不同，说各种模式都有自己的优缺点，分别适合不同的应用场景，不过最终本质的功能都是能实现均衡的流量调度和良好的扩展性。主要包括以下三种模式</p>
<ul>
<li>DR 模式</li>
<li>NAT 模式</li>
<li>Tunnel 模式</li>
</ul>
<p>另外必须要说的模式是 FullNAT，这个模式在开源版本中是模式没有的，<a target="_blank" rel="noopener" href="http://kb.linuxvirtualserver.org/wiki/IPVS_FULLNAT_and_SYNPROXY">代码</a> 没有合并进入内核主线版本，后面会有专门章节详细介绍 FullNAT 模式。下边分别就 DR、NAT、Tunnel 模式分别详细介绍原理。</p>
<h2 id="三、DR-模式实现原理"><a href="#三、DR-模式实现原理" class="headerlink" title="三、DR 模式实现原理"></a>三、DR 模式实现原理</h2><p>LVS 基本原理图（上图）中描述的比较简单，表述的是比较通用流程。下边会针对 DR 模式的具体实现原理，详细的阐述 DR 模式是如何工作的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chopin11/image001/lb005dr.png" alt="LVS DR 模式原理图"></p>
<p>其实 DR 是最常用的工作模式，因为它的强大的性能。下边以一次请求和响应数据流的过程来描述 DR 模式的具体原理</p>
<p><strong>（一）实现原理过程</strong></p>
<ul>
<li><p>① 当客户端请求 <a target="_blank" rel="noopener" href="http://www.sina.com.cn/">www.sina.com.cn</a> 主页，经过 DNS 解析到 IP 后，向新浪服务器发送请求数据，数据包经过层层网络到达新浪负载均衡 LVS 服务器，到达 LVS 网卡时的数据包：源 IP 是客户端 IP 地址 CIP，目的 IP 是新浪对外的服务器 IP 地址，也就是 VIP；此时源 MAC 地址是 CMAC，其实是 LVS 连接的路由器的 MAC 地址（为了容易理解记为 CMAC），目标 MAC 地址是 VIP 对应的 MAC，记为 VMAC。</p>
</li>
<li><p>② 数据包到达网卡后，经过链路层到达 PREROUTING 位置（刚进入网络层），查找路由发现目的 IP 是 LVS 的 VIP，就会递送到 INPUT 链上，此时数据包 MAC、IP、Port 都没有修改。</p>
</li>
<li><p>③ 数据包到达 INPUT 链，INPUT 是 LVS 主要工作的位置。此时 LVS 会根据目的 IP 和 Port 来确认是否是 LVS 定义的服务，如果是定义过的 VIP 服务，就会根据配置的 Service 信息，从 RealServer 中选择一个作为后端服务器 RS1，然后以 RS1 作为目标查找 Out 方向的路由，确定一下跳信息以及数据包要通过哪个网卡发出。最后将数据包通过 INET_HOOK 到 OUTPUT 链上（Out 方向刚从四层进入网络层）。</p>
</li>
<li><p>④ 数据包通过 POSTROUTING 链后，从网络层转到链路层，将目的 MAC 地址修改为 RealServer 服务器 MAC 地址，记为 RMAC；而源 MAC 地址修改为 LVS 与 RS 同网段的 selfIP 对应的 MAC 地址，记为 DMAC。此时，数据包通过交换机转发给了 RealServer 服务器（注：为了简单图中没有画交换机）。</p>
</li>
<li><p>⑤ 请求数据包到达 RealServer 服务器后，链路层检查目的 MAC 是自己网卡地址。到了网络层，查找路由，目的 IP 是 VIP（lo 上配置了 VIP），判定是本地主机的数据包，经过协议栈后拷贝至应用程序（比如这里是 nginx 服务器），nginx 响应请求后，产生响应数据包。以目的 VIP 为 dst 查找 Out 路由，确定吓一跳信息和发送网卡设备信息，发送数据包。此时数据包源、目的 IP 分别是 VIP、CIP，而源 MAC 地址是 RS1 的 RMAC，目的 MAC 是下一跳（路由器）的 MAC 地址，记为 CMAC（为了容易理解，记为 CMAC）。然后数据包通过 RS 相连的路由器转发给真正客户端。</p>
</li>
</ul>
<blockquote>
<p>从整个过程可以看出，DR 模式 LVS 逻辑非常简单，数据包通过路由方式直接转发给 RS，而且响应数据包是由 RS 服务器直接发送给客户端，不经过 LVS。我们知道一般请求数据包会比较小，响应报文较大，经过 LVS 的数据包基本上都是小包，上述几条因素是 LVS 的 DR 模式性能强大的主要原因。</p>
</blockquote>
<p><strong>（二）优缺点和使用场景</strong></p>
<ul>
<li><p>DR 模式的优点</p>
<blockquote>
<p>a. 响应数据不经过 lvs，性能高<br>b. 对数据包修改小，信息保存完整（携带客户端源 IP）  </p>
</blockquote>
</li>
<li><p>DR 模式的缺点</p>
<blockquote>
<p>a. lvs 与 rs 必须在同一个物理网络（不支持跨机房）<br>b. rs 上必须配置 lo 和其它内核参数<br>c. 不支持端口映射</p>
</blockquote>
</li>
<li><p>DR 模式的使用场景</p>
<blockquote>
<p>如果对性能要求非常高，可以首选 DR 模式，而且可以透传客户端源 IP 地址。</p>
</blockquote>
</li>
</ul>
<h2 id="四、NAT-模式实现原理"><a href="#四、NAT-模式实现原理" class="headerlink" title="四、NAT 模式实现原理"></a>四、NAT 模式实现原理</h2><p>lvs 的第 2 种工作模式是 NAT 模式，下图详细介绍了数据包从客户端进入 lvs 后转发到 rs，后经 rs 再次将响应数据转发给 lvs，由 lvs 将数据包回复给客户端的整个过程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chopin11/image001/lb006nat.png" alt="LVS DR 模式原理图"></p>
<p><strong>（一）实现原理与过程</strong></p>
<ul>
<li>① 用户请求数据包经过层层网络，到达 lvs 网卡，此时数据包源 IP 是 CIP，目的 IP 是 VIP。</li>
<li>② 经过网卡进入网络层 prerouting 位置，根据目的 IP 查找路由，确认是本机 IP，将数据包转发到 INPUT 上，此时源、目的 IP 都未发生变化。</li>
<li>③ 到达 lvs 后，通过目的 IP 和目的 port 查找是否为 IPVS 服务。若是 IPVS 服务，则会选择一个 RS 作为后端服务器，将数据包目的 IP 修改为 RIP，并以 RIP 为目的 IP 查找路由信息，确定下一跳和出口信息，将数据包转发至 output 上。</li>
<li>④ 修改后的数据包经过 postrouting 和链路层处理后，到达 RS 服务器，此时的数据包源 IP 是 CIP，目的 IP 是 RIP。</li>
<li>⑤ 到达 RS 服务器的数据包经过链路层和网络层检查后，被送往用户空间 nginx 程序。nginx 程序处理完毕，发送响应数据包，由于 RS 上默认网关配置为 lvs 设备 IP，所以 nginx 服务器会将数据包转发至下一跳，也就是 lvs 服务器。此时数据包源 IP 是 RIP，目的 IP 是 CIP。</li>
<li>⑥ lvs 服务器收到 RS 响应数据包后，根据路由查找，发现目的 IP 不是本机 IP，且 lvs 服务器开启了转发模式，所以将数据包转发给 forward 链，此时数据包未作修改。</li>
<li>⑦ lvs 收到响应数据包后，根据目的 IP 和目的 port 查找服务和连接表，将源 IP 改为 VIP，通过路由查找，确定下一跳和出口信息，将数据包发送至网关，经过复杂的网络到达用户客户端，最终完成了一次请求和响应的交互。</li>
</ul>
<blockquote>
<p>NAT 模式双向流量都经过 LVS，因此 NAT 模式性能会存在一定的瓶颈。不过与其它模式区别的是，NAT 支持端口映射，且支持 windows 操作系统。</p>
</blockquote>
<p><strong>（二）优点、缺点与使用场景</strong></p>
<ul>
<li><p>NAT 模式优点</p>
<blockquote>
<p>a. 能够支持 windows 操作系统<br>b. 支持端口映射。如果 rs 端口与 vport 不一致，lvs 除了修改目的 IP，也会修改 dport 以支持端口映射。</p>
</blockquote>
</li>
<li><p>NAT 模式缺点</p>
<blockquote>
<p>a. 后端 RS 需要配置网关<br>b. 双向流量对 lvs 负载压力比较大</p>
</blockquote>
</li>
<li><p>NAT 模式的使用场景</p>
<blockquote>
<p>如果你是 windows 系统，使用 lvs 的话，则必须选择 NAT 模式了。</p>
</blockquote>
</li>
</ul>
<h2 id="五、Tunnel-模式实现原理"><a href="#五、Tunnel-模式实现原理" class="headerlink" title="五、Tunnel 模式实现原理"></a>五、Tunnel 模式实现原理</h2><p>Tunnel 模式在国内使用的比较少，不过据说腾讯使用了大量的 Tunnel 模式。它也是一种单臂的模式，只有请求数据会经过 lvs，响应数据直接从后端服务器发送给客户端，性能也很强大，同时支持跨机房。下边继续看图分析原理。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chopin11/image001/lb007tunnel.png" alt="Tunnel 原理图"></p>
<p><strong>（一）实现原理与过程</strong></p>
<ul>
<li>① 用户请求数据包经过多层网络，到达 lvs 网卡，此时数据包源 IP 是 cip，目的 ip 是 vip。</li>
<li>② 经过网卡进入网络层 prerouting 位置，根据目的 ip 查找路由，确认是本机 ip，将数据包转发到 input 链上，到达 lvs，此时源、目的 ip 都未发生变化。</li>
<li>③ 到达 lvs 后，通过目的 ip 和目的 port 查找是否为 IPVS 服务。若是 IPVS 服务，则会选择一个 rs 作为后端服务器，以 rip 为目的 ip 查找路由信息，确定下一跳、dev 等信息，然后 IP 头部前边额外增加了一个 IP 头（以 dip 为源，rip 为目的 ip），将数据包转发至 output 上。</li>
<li>④ 数据包根据路由信息经最终经过 lvs 网卡，发送至路由器网关，通过网络到达后端服务器。</li>
<li>⑤ 后端服务器收到数据包后，ipip 模块将 Tunnel 头部卸载，正常看到的源 ip 是 cip，目的 ip 是 vip，由于在 tunl0 上配置 vip，路由查找后判定为本机 ip，送往应用程序。应用程序 nginx 正常响应数据后以 vip 为源 ip，cip 为目的 ip 数据包发送出网卡，最终到达客户端。</li>
</ul>
<blockquote>
<p>Tunnel 模式具备 DR 模式的高性能，又支持跨机房访问，听起来比较完美了。不过国内运营商有一定特色性，比如 RS 的响应数据包的源 IP 为 VIP，VIP 与后端服务器有可能存在跨运营商的情况，有可能被运营商的策略封掉。Tunnel 在生产环境确实没有使用过，在国内推行 Tunnel 可能会有一定的难度吧。</p>
</blockquote>
<p><strong>（二）优点、缺点与使用场景</strong></p>
<ul>
<li><p>Tunnel 模式的优点</p>
<blockquote>
<p>a. 单臂模式，对 lvs 负载压力小<br>b. 对数据包修改较小，信息保存完整<br>c. 可跨机房（不过在国内实现有难度）</p>
</blockquote>
</li>
<li><p>Tunnel 模式的缺点</p>
<blockquote>
<p>a. 需要在后端服务器安装配置 ipip 模块<br>b. 需要在后端服务器 tunl0 配置 vip<br>c. 隧道头部的加入可能导致分片，影响服务器性能<br>d. 隧道头部 IP 地址固定，后端服务器网卡 hash 可能不均<br>e. 不支持端口映射</p>
</blockquote>
</li>
<li><p>Tunnel 模式的使用场景</p>
<blockquote>
<p>理论上，如果对转发性能要求较高，且有跨机房需求，Tunnel 可能是较好的选择。</p>
</blockquote>
</li>
</ul>
<h2 id="六、涉及的概念术语"><a href="#六、涉及的概念术语" class="headerlink" title="六、涉及的概念术语"></a>六、涉及的概念术语</h2><p>上述内容中涉及到很多术语或缩写，这里简单解释下具体的含义，便于理解。</p>
<blockquote>
<ul>
<li><code>CIP</code>：Client IP，表示的是客户端 IP 地址。</li>
<li><code>VIP</code>：Virtual IP，表示负载均衡对外提供访问的 IP 地址，一般负载均衡 IP 都会通过 Virtual IP 实现高可用。</li>
<li><code>RIP</code>：RealServer IP，表示负载均衡后端的真实服务器 IP 地址。</li>
<li><code>DIP</code>：Director IP，表示负载均衡与后端服务器通信的 IP 地址。</li>
<li><code>CMAC</code>：客户端的 MAC 地址，准确的应该是 LVS 连接的路由器的 MAC 地址。</li>
<li><code>VMAC</code>：负载均衡 LVS 的 VIP 对应的 MAC 地址。</li>
<li><code>DMAC</code>：负载均衡 LVS 的 DIP 对应的 MAC 地址。</li>
<li><code>RMAC</code>：后端真实服务器的 RIP 地址对应的 MAC 地址。</li>
</ul>
</blockquote>
<p>基础性的原理知识，暂时分析理解到这里就可以了，后边内容会尽量以实践的方式来进一步了解 LVS 的工作原理和基本操作使用方式。</p>

        
<script src="/js/qrious.min.js"></script>


        <hr style="margin-top: 2rem;">
        <div>
            
            <p>
                <span>专题: </span>
                
                <a href="/series/#负载均衡">
                    <code key="负载均衡" class="post-label">负载均衡</code>
                </a>
                
            </p>
            
            <p>
                <span>本文发表于 2021-03-06，最后修改于 2022-04-16。</span>
            </p>
            <!-- 文章末尾的提示 start -->
            
            <p>
                本站永久域名「 <a
                        href="/post/1970613528.html">www.tcpdump.cn</a>
                    」，也可搜索「 肖邦Linux 」找到我。
            </p>
            
            
                
            <!-- 文章末尾的提示 end -->
        </div>
        <hr />
        <p name="pagination" style="font-size: 1.2em">
    
    <a class="float-left" href="/post/2589298645.html">上一篇 « 负载均衡 LVS 基本介绍</a>
    
    
    <a class="float-right" href="/post/3671532823.html">下一篇 » 负载均衡 LVS 操作实践</a>
    
</p>
    </article>
    <!-- 赞赏 -->
    <!--打赏-->

<style>
    #reward .reward-btn-wrapper {
        width: 100px;
        padding-top: 35px;
        cursor: pointer;
        margin: 0 auto;
    }

    #reward .reward-btn {
        padding: 2px 15px;
        color: #fff;
        background-color: #ea6f5a;
        border-radius: 20px;
    }

    #reward .reward-code {
        position: absolute;
        top: -220px;
        left: 50%;
        display: none;
        width: 360px;
        height: 240px;
        margin-left: -180px;
        padding: 15px 20px;
        border: 1px solid #e6e6e6;
        background: #fff;
        box-shadow: 0 1px 1px 1px #efefef;
    }

    #reward .reward-code:after,
    #reward .reward-code:before {
        position: absolute;
        content: '';
        border: 10px solid transparent
    }

    #reward .reward-code:after {
        bottom: -19px;
        left: 50%;
        margin-left: -10px;
        border-top-color: #fff
    }

    #reward .reward-code:before {
        bottom: -20px;
        left: 50%;
        margin-left: -10px;
        border-top-color: #e6e6e6
    }

    #reward .qr-code {
        width: 50%;
        float: left;
        padding: 5px;
    }

    #reward .qr-code p {
        margin-top: -6px;
    }

    #reward img {
        transform: none;
        -webkit-transform: none;
        margin-left: 0;
    }

    #reward img[alt='i'] {
        width: 20px;
        height: 20px;
        z-index: 2;
        position: absolute;
        margin: 65px 0 0 65px;
    }

    #reward img[alt="ali"] {
        width: 100%;
        box-sizing: border-box;
        border: 5px solid #0f9be0;
    }

    #reward img[alt="wechat"] {
        width: 100%;
        box-sizing: border-box;
        border: 5px solid #3db034;
    }

    #reward .reward-tip {
        font-size: 1.2em;
        margin-bottom: 0;
        color: #ea6f5a;
    }
</style>
<div id="reward" class="col-xs-12">
    <div class="reward-btn-wrapper">
        <div class="reward-btn text-center">赞赏支持</div>
    </div>
    <div class="reward-code text-center">
        <p class="text-center reward-tip"><strong>请我吃胡萝卜 =^_^= </strong></p>
        <div class="qr-code">
            <img src="/img/favicon.ico" alt="i">
            <img id="reward-ali" src="" alt="ali">
            <p><small>支付宝</small></p>
        </div>
        <div class="qr-code">
            <img src="/img/favicon.ico" alt="i">
            <img id="reward-wechat" src="" alt="wechat">
            <p><small>微信</small></p>
        </div>
    </div>
</div>
<script>
    (function (window, document) {
        var aliQr = new QRious({ value: 'HTTPS://QR.ALIPAY.COM/FKX060337TUXBAX9LIFJE8' });
        var wechatQr = new QRious({ value: 'wxp://f2f0qgGBlfD1nZXjvBjievxB0z0fc0W2sBq5' });
        document.querySelector('#reward-ali').src = aliQr.toDataURL();
        document.querySelector('#reward-wechat').src = wechatQr.toDataURL();

        var rewardBtn = document.querySelector('#reward .reward-btn-wrapper');
        var qrCode = document.querySelector('#reward .reward-code')
        var activeFunc = function (e) {
            qrCode.style.display = 'block';
        }
        var hideFunc = function (e) {
            qrCode.style.display = 'none';
        }

        rewardBtn.addEventListener('mouseenter', activeFunc, false)
        rewardBtn.addEventListener('mouseover', activeFunc, false)
        rewardBtn.addEventListener('mouseleave', hideFunc, false)
        qrCode.addEventListener('mouseenter', activeFunc, false)
        qrCode.addEventListener('mouseover', activeFunc, false)
        qrCode.addEventListener('mouseleave', hideFunc, false)
    })(window, document);
</script>

    
<div class="col-xs-12 text-center" style="margin-top: 30px;">
    
    <a style="display:inline-block;" target="_blank" rel="noopener" href="https://github.com/chopin11" title="Github"><img style="padding:5px;width:30px;margin-left:0;transform:none;-webkit-transform:none;" src="/img/related_links/github.png" /></a>
    
    <a style="display:inline-block;" target="_blank" rel="noopener" href="https://geektutu.com/feed.xml" title="RSS"><img style="padding:5px;width:30px;margin-left:0;transform:none;-webkit-transform:none;" src="/img/related_links/rss.jpg" /></a>
    
    <a style="display:inline-block;" target="_blank" rel="noopener" href="https://www.zhihu.com/people/gzdaijie" title="知乎"><img style="padding:5px;width:30px;margin-left:0;transform:none;-webkit-transform:none;" src="/img/related_links/zhihu.png" /></a>
    
    <a style="display:inline-block;" target="_blank" rel="noopener" href="https://weibo.com/geektutu" title="微博"><img style="padding:5px;width:30px;margin-left:0;transform:none;-webkit-transform:none;" src="/img/related_links/weibo.jpg" /></a>
    
</div>

    <!-- 推荐阅读三篇文章 -->
    <div class="col-xs-12">
        <h3>推荐阅读</h3>
        
        <div class="post-preview">
    <div class="post-img" style="background-image: url('/img/golang.jpg')"></div>
    <div class="post-info">
        <div class="post-info-center">
            <div class="hidden-xs">
                
                
                <span>/</span>
                
                <a class="text-gray" href="/tags/#HTTPS"
                    title="HTTPS">HTTPS</a>
                <span>/</span>
                
                <a class="text-gray" href="/tags/#OPENSSL"
                    title="OPENSSL">OPENSSL</a>
                <span>/</span>
                
                <a class="text-gray" href="/tags/#签发证书"
                    title="签发证书">签发证书</a>
                <span>/</span>
                
                
            </div>
            <a href="/post/1717622242.html" class="title">
                使用 openssl 操作证书的常见用法
            </a>
            <p class="text-gray">
                <small>
                    <span>发表于2022-04-08，</span>
                    <span class="hidden-xs">全文2312字，</span>
                    <span>阅读约8分钟</span>
                </small>
            </p>
        </div>
    </div>
</div>
        
        <div class="post-preview">
    <div class="post-img" style="background-image: url('/img/golang.jpg')"></div>
    <div class="post-info">
        <div class="post-info-center">
            <div class="hidden-xs">
                
                
                <span>/</span>
                
                <a class="text-gray" href="/tags/#HTTPS"
                    title="HTTPS">HTTPS</a>
                <span>/</span>
                
                <a class="text-gray" href="/tags/#OPENSSL"
                    title="OPENSSL">OPENSSL</a>
                <span>/</span>
                
                <a class="text-gray" href="/tags/#签发证书"
                    title="签发证书">签发证书</a>
                <span>/</span>
                
                
            </div>
            <a href="/post/3965235630.html" class="title">
                使用 openssl 签发 RSA 证书
            </a>
            <p class="text-gray">
                <small>
                    <span>发表于2022-04-08，</span>
                    <span class="hidden-xs">全文4150字，</span>
                    <span>阅读约14分钟</span>
                </small>
            </p>
        </div>
    </div>
</div>
        
        <div class="post-preview">
    <div class="post-img" style="background-image: url('/img/golang.jpg')"></div>
    <div class="post-info">
        <div class="post-info-center">
            <div class="hidden-xs">
                
                
                <span>/</span>
                
                <a class="text-gray" href="/tags/#负载均衡"
                    title="负载均衡">负载均衡</a>
                <span>/</span>
                
                <a class="text-gray" href="/tags/#lvs"
                    title="lvs">lvs</a>
                <span>/</span>
                
                <a class="text-gray" href="/tags/#toa"
                    title="toa">toa</a>
                <span>/</span>
                
                
            </div>
            <a href="/post/1229090889.html" class="title">
                负载均衡 LVS TOA 实现原理
            </a>
            <p class="text-gray">
                <small>
                    <span>发表于2021-08-16，</span>
                    <span class="hidden-xs">全文4389字，</span>
                    <span>阅读约15分钟</span>
                </small>
            </p>
        </div>
    </div>
</div>
        
    </div>
    <div class="col-xs-12">
        <!-- 标签列表 -->
        <!-- Featured Tags -->
<style>
    #featured-tag .post-tag-item {
        font-size: 12px;
        line-height: 30px;
        display: inline-block;
        height: 30px;
        margin: 5px 0px;
        padding: 0 7px;
        color: #333;
        border-radius: 15px;
        background: #f6f6f6;
    }

    #featured-tag .post-tag-item:hover {
        color: #337ab7;
    }
</style>
<div id="featured-tag">
    
    <a class="post-tag-item" href="/tags/#keepalived" title="keepalived"
        rel="1">#keepalived (1) </a>
    
    <a class="post-tag-item" href="/tags/#负载均衡" title="负载均衡"
        rel="9">#负载均衡 (9) </a>
    
    <a class="post-tag-item" href="/tags/#高可用" title="高可用"
        rel="1">#高可用 (1) </a>
    
    <a class="post-tag-item" href="/tags/#dpvs" title="dpvs"
        rel="3">#dpvs (3) </a>
    
    <a class="post-tag-item" href="/tags/#路由" title="路由"
        rel="1">#路由 (1) </a>
    
    <a class="post-tag-item" href="/tags/#邻居" title="邻居"
        rel="1">#邻居 (1) </a>
    
    <a class="post-tag-item" href="/tags/#linux" title="linux"
        rel="1">#linux (1) </a>
    
    <a class="post-tag-item" href="/tags/#HTTPS" title="HTTPS"
        rel="8">#HTTPS (8) </a>
    
    <a class="post-tag-item" href="/tags/#OPENSSL" title="OPENSSL"
        rel="8">#OPENSSL (8) </a>
    
    <a class="post-tag-item" href="/tags/#签发证书" title="签发证书"
        rel="8">#签发证书 (8) </a>
    
    <a class="post-tag-item" href="/tags/#lvs" title="lvs"
        rel="7">#lvs (7) </a>
    
    <a class="post-tag-item" href="/tags/#TCP" title="TCP"
        rel="1">#TCP (1) </a>
    
    <a class="post-tag-item" href="/tags/#网络协议" title="网络协议"
        rel="1">#网络协议 (1) </a>
    
    <a class="post-tag-item" href="/tags/#工具效率" title="工具效率"
        rel="1">#工具效率 (1) </a>
    
    <a class="post-tag-item" href="/tags/#调度算法" title="调度算法"
        rel="1">#调度算法 (1) </a>
    
    <a class="post-tag-item" href="/tags/#toa" title="toa"
        rel="1">#toa (1) </a>
    
    <a class="post-tag-item" href="/tags/#snat" title="snat"
        rel="1">#snat (1) </a>
    
    <a class="post-tag-item" href="/tags/#关于我" title="关于我"
        rel="1">#关于我 (1) </a>
    
    <a class="post-tag-item" href="/tags/#友链" title="友链"
        rel="1">#友链 (1) </a>
    
</div>
    </div>
    <!-- 评论 -->
    
    <div class="col-xs-12">
        
<div class="col-xs-12 padding-0">
    <div id="gitalk-container">
        <div class="gt-container text-center" style="margin-top: 50px;">
            <button class="gt-btn gt-btn-public"><span class="gt-btn-text">去 Github 评论</span></button>
        </div>
    </div>
    <div id="gitalk-related"></div>
</div>

<link rel="stylesheet" href="/css/gitalk.css">


<script src="/js/gitalk.min.js"></script>

<script>
    window.addEventListener('load', function () {
        function renderCommentUrl(data) {
            var url = (data[window.location.pathname] || {}).url
            url && getDom('#gitalk-container button').addEventListener('click', function (e) { window.open(url)})
            url || (getDom('#gitalk-container').style.display = 'none')
        }
        const gitalk = new Gitalk({
            clientID: '03fc618319525989f942',
            clientSecret: '6c8d8f219e914bc85a22766f478f1b7dec6586d7',
            accessToken: '',
            repo: 'blog-comment',
            owner: 'chopin11',
            admin: ['chopin11'],
            id: window.location.pathname,
            distractionFreeMode: false
        });
        fetch("https://api.github.com/user").then(function(resp){
            gitalk.render('gitalk-container');
        }).catch(function(e){
            fetch('/tool/issues.json').then(function (r) { return r.json() }).then(renderCommentUrl).catch(function (e) { })
        })
        getDom('#gitalk-container').addEventListener('click', function (e) {
            e && e.stopPropagation && e.stopPropagation();
        });
    })
</script>
<script>
    window.addEventListener('load', function () {
        function render(comments) {
            var template = '<a href="${comment.url}?utm_source=gitalk" class="dis-item-url"><h3 class="dis-item-title">${comment.title}</h3>' +
                '<p class="dis-item-des">${comment.count} 评论 ● ${comment.date}</p>' +
                '<div class="dis-item-content"><img class="dis-item-img" src="${comment.icon}" alt="icon"><p><b><span class="dis-item-user">${comment.user}</span></b>&nbsp;——&nbsp;${comment.body}</p></div>' +
                '</a>'

            var wrapper = getDom('#gitalk-related');
            comments = shuffle(comments);
            comments.slice(0, 4).forEach(function (c) {
                var div = document.createElement('div');
                div.classList.add('dis-item');
                div.innerHTML = template.replace("${comment.url}", c.url)
                    .replace("${comment.title}", c.title)
                    .replace("${comment.count}", c.count)
                    .replace("${comment.date}", c.date)
                    .replace("${comment.icon}", c.icon)
                    .replace("${comment.user}", c.user)
                    .replace("${comment.body}", c.body)
                wrapper.appendChild(div)
            })
            var p = document.createElement('p')
            p.innerHTML = '<a target="_blank" rel="noopener" href="https://geektutu.com/post/blog-experience-7.html">Gitalk Plus</a>';
            p.classList.add('dis-divide');
            wrapper.appendChild(p);
            wrapper.classList.add('dis-wrapper')
        }
        function shuffle(a) {
            for (var i = a.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        fetch('/tool/comments.json').then(function (r) { return r.json() }).then(render).catch(function (e) { })
    })
</script>

    </div>
    
</div>
<aside class="float-left gkt-sidebar hidden-xs hidden-sm">
    <div style="clear: both"></div>
    <div class="gkt-sidebar-wrapper">
        <section class="box-shadow"><style>
    .gkt-summary {
        border: 1px solid #DDDDDD;
        border-radius: 3px;
        padding: 5px;
        width: 100%;
    }


    .gkt-summary nav {
        overflow: hidden;
    }

    .gkt-summary nav a {
        display: inline-block;
        text-align: center;
        color: #333;
        font-size: 12px;
    }

    .gkt-summary nav span {
        display: block;
    }

    .gkt-summary nav .middle {
        border-left: 1px solid #eaecef;
        border-right: 1px solid #eaecef;
    }

    .gkt-summary .number {
        font-weight: bold;
    }

    .gkt-summary .link-list {
        margin-top: 5px;
        margin-bottom: -5px;
        padding-top: 7px;
        border-top: 1px dashed #999;
        display: flex;
    }

    .gkt-summary .link-list a {
        flex: 1;
    }

    .gkt-summary .link-list img {
        width: 25px;
        height: 25px;
    }
</style>

<div class="gkt-summary">
    <nav>
        <a href="/" class="col-xs-4">
            <span class="number">24</span><span>文章</span>
        </a>
        <a href="/series" class="col-xs-4 middle">
            <span class="number">6</span><span>专题</span>
        </a>
        <a href="/tags" class="col-xs-4">
            <span class="number">19</span><span>标签</span>
        </a>
    </nav>

    
    <div class="link-list">
        
        <a target="_blank" rel="noopener" href="https://github.com/chopin11"><img src="/img/related_links/github.png" /></a>
        
        <a target="_blank" rel="noopener" href="https://geektutu.com/feed.xml"><img src="/img/related_links/rss.jpg" /></a>
        
        <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/gzdaijie"><img src="/img/related_links/zhihu.png" /></a>
        
        <a target="_blank" rel="noopener" href="https://weibo.com/geektutu"><img src="/img/related_links/weibo.jpg" /></a>
        
    </div>
    
</div></section>
        
        
        <section class="gkt-sidebar-content box-shadow">
            <strong>负载均衡</strong>
            <ul>
                
                <li>
                    <a href="/post/325553977.html"
                        class="">keepalived 快速入门介绍</a>
                    
                </li>
                
                <li>
                    <a href="/post/2589298645.html"
                        class="">负载均衡 LVS 基本介绍</a>
                    
                </li>
                
                <li>
                    <a href="/post/1970613528.html"
                        class="gkt-sidebar-active">负载均衡 LVS 基本原理</a>
                    
                    <!-- Table of Contents -->
<div id="sidebar-toc">
  <!-- TOC  -->
  
  
  <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%80%E3%80%81netfilter%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-nav-text">一、netfilter基本原理</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BA%8C%E3%80%81LVS%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="toc-nav-text">二、LVS基本原理</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%B8%89%E3%80%81DR-%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-text">三、DR 模式实现原理</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%9B%9B%E3%80%81NAT-%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-text">四、NAT 模式实现原理</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E4%BA%94%E3%80%81Tunnel-%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-nav-text">五、Tunnel 模式实现原理</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%85%AD%E3%80%81%E6%B6%89%E5%8F%8A%E7%9A%84%E6%A6%82%E5%BF%B5%E6%9C%AF%E8%AF%AD"><span class="toc-nav-text">六、涉及的概念术语</span></a></li></ol>
  
</div>

<script>
  (function () {
    var h2 = document.querySelectorAll('article h2');
    var h3 = document.querySelectorAll('article h3');
    var linkList = document.querySelectorAll('#sidebar-toc a');

    function findLinkElement(name) {
      for (var i = 0; i < linkList.length; i++) {
        var items = linkList[i].href.split('#');
        if (items && items[items.length - 1] === encodeURIComponent(name)) {
          return i;
        }
      }
      return -1;
    }

    function activeLink(titleList) {
      var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      for (var i = titleList.length - 1; i >= 0; i--) {
        if (scrollTop - titleList[i].offsetTop > 0) {
          var index = findLinkElement(titleList[i].id);
          index != -1 && linkList[index].classList.add('gkt-sidebar-active');
          break;
        }
      }
    }

    window.addEventListener("scroll", function (e) {
      [].slice.call(linkList).forEach(function (link) {
        link.classList.remove('gkt-sidebar-active');
      })
      activeLink(h2);
    })
  })();
</script>
                    
                </li>
                
                <li>
                    <a href="/post/3671532823.html"
                        class="">负载均衡 LVS 操作实践</a>
                    
                </li>
                
                <li>
                    <a href="/post/2126991808.html"
                        class="">负载均衡 LVS 连接表</a>
                    
                </li>
                
                <li>
                    <a href="/post/522418658.html"
                        class="">负载均衡 LVS 调度算法</a>
                    
                </li>
                
                <li>
                    <a href="/post/3360290171.html"
                        class="">负载均衡 LVS 主流程代码分析</a>
                    
                </li>
                
                <li>
                    <a href="/post/1229090889.html"
                        class="">负载均衡 LVS TOA 实现原理</a>
                    
                </li>
                
                <li>
                    <a href="/post/2778281555.html"
                        class="">负载均衡 DPVS SNAT 功能介绍</a>
                    
                </li>
                
                <li>
                    <a href="/post/3989527185.html"
                        class="">负载均衡 DPVS 路由子系统的实现</a>
                    
                </li>
                
                <li>
                    <a href="/post/4205823097.html"
                        class="">负载均衡 DPVS 邻居子系统的实现</a>
                    
                </li>
                
            </ul>
        </section>
        
        
        <section class="gkt-sidebar-content box-shadow">
            <strong>最近的文章</strong>
            <ul>
                
                <li>
                    <a href="/post/55249683.html">让浏览器快如飞的插件 vimium</a>
                </li>
                
                <li>
                    <a href="/post/1335797944.html">经典的 TCP 三次握手问题</a>
                </li>
                
                <li>
                    <a href="/post/1717622242.html">使用 openssl 操作证书的常见用法</a>
                </li>
                
            </ul>
        </section>
        
    </div>
</aside>

<script>
    (function () {
        function resizeUArrow() {
            var s = getDom('.u-arrow-wrapper').style
            var pc = getDom('.post-container')
            s.left = getPosition(pc).x + 'px';
            s.width = pc.clientWidth + 'px';
        }
        resizeUArrow()
        window.addEventListener('resize', resizeUArrow);
    })();
</script>

    

<script>
    (function () {
        var ele = getDom('.gkt-sidebar-content')
        if(!ele) return;
        var wrapper = getDom('.gkt-sidebar-wrapper')
        var last = 0
        ele.style.maxHeight = ((window.innerHeight || 798) - 200) + 'px'
        var f = function (e) {
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            var isDown = scrollTop > last;
            var pos = getPosition(ele).y - scrollTop;
            var downLimit = 50;
            var upLimit = -100;
            // uarrow.style.marginTop = scrollTop + 'px';
            isDown && pos <= downLimit && wrapper.classList.add("gkt-sidebar-fixed");
            !isDown && pos > upLimit && wrapper.classList.remove("gkt-sidebar-fixed");
            last = scrollTop
        }
        f()
        window.addEventListener("scroll", f)
    })();
</script>

</main>
    </div>
    <style>
    img#go-top {
        position: fixed;
        bottom: 100px;
        width: 50px;
        cursor: pointer;
        z-index: 9999;
    }
</style>
<img id="go-top" src="/icon/top.png" class="hidden-xs" style="display: none" />
<script>
    (function () {
        var goTop = document.getElementById('go-top');
        var mainContainer = document.querySelector('.main-container');
        
        goTop.addEventListener('click', function () {
            window.scroll(0, 0);
        }, false);
        window.addEventListener('scroll', function () {
            var right = document.body.offsetWidth - mainContainer.getBoundingClientRect().right;
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            goTop.style.right = right + 10 + 'px'
            scrollTop > 700 && (goTop.style.display = "block");
            scrollTop <= 700 && (goTop.style.display = "none");
        });
    })();
</script>
    <style>
    #geektutu-click-img-container {
        position: fixed;
        left: 0;
        top: 0;
        text-align: center;
        width: 100%;
        display: none;
        z-index: 9999;
    }

    #geektutu-click-img-container img {
        object-fit: contain;
        background: #eaecef;
        padding: 15px;
        border-radius: 10px;
        height: auto;
        width: auto;
        vertical-align: middle;
    }
</style>


<div id="geektutu-click-img-container">
    <img src="" alt="Big Image">
</div>

<script>
    (function () {
        var container = document.querySelector('#geektutu-click-img-container')
        var targetImg = container.querySelector('img')
        var imgs = document.querySelectorAll('article img');
        targetImg.addEventListener('click', function (e) {
            container.style.display = 'none';
            e && e.stopPropagation && e.stopPropagation();
        }, false);

        for (var i = 0; i < imgs.length; ++i) {
            var img = imgs[i];
            img.addEventListener('click', (function (src, rate) {
                return function (e) {
                    e && e.stopPropagation && e.stopPropagation();
                    if (window.innerWidth < 980) {
                        return
                    }
                    targetImg.style.height = targetImg.style.width = 'auto';
                    if (window.innerWidth / window.innerHeight > rate) {
                        targetImg.style.height = (window.innerHeight - 20) + 'px';
                    } else {
                        targetImg.style.width = (window.innerWidth - 20) + 'px';
                    }
                    container.style.height = window.innerHeight + 'px'
                    container.style.lineHeight = window.innerHeight + 'px'
                    container.style.display = 'block';
                    targetImg.src = src;
                };
            }(img.src, img.width / img.height)), false)
        }
    })();
</script>
    <!-- Footer -->
    <!-- Footer -->
<style>
    footer {
        width: 100%;
        line-height: 1.5;
        padding: 20px;
    }

    footer a {
        color: #333;
        text-decoration: none;
    }

    .footer-hexo img {
        height: 20px;
        margin-bottom: -5px;
    }

    .footer-hexo a {
        color: #337ab7;
    }
</style>
<footer class="text-center col-xs-12">
    <p>
        <small>©2019 - 2022 - 肖邦 - </small>
        <small>
            <a target="_blank" rel="nofollow noopener" href="http://beian.miit.gov.cn/">临渊羡鱼，不如退而结网</a>
        </small>
    </p>
    <p class="footer-hexo">
        <!-- 但若直接使用或修改主题，请务必保留这段声明 -->
        <small>Powered by <a target="_blank" href="https://hexo.io">Hexo</a> | Theme
            <a target="_blank" href="https://geektutu.com">Geektutu</a>
            <a target="_blank" rel="noopener" href="https://github.com/chopin11">
                <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAYGBgYHBgcICAcKCwoLCg8ODAwODxYQERAREBYiFRkVFRkVIh4kHhweJB42KiYmKjY+NDI0PkxERExfWl98fKcBBgYGBgcGBwgIBwoLCgsKDw4MDA4PFhAREBEQFiIVGRUVGRUiHiQeHB4kHjYqJiYqNj40MjQ+TERETF9aX3x8p//CABEIACIAUAMBIgACEQEDEQH/xAAcAAABBAMBAAAAAAAAAAAAAAAAAQQFBwIDBgj/2gAIAQEAAAAA9KrHSgAYL5/z6zZGuJd12uugbhq3uKtmuRtix20IS7lTLAfAAAn/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oACAECEAAAAAAB/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAgBAxAAAAAAAf/EADEQAAICAQIEBQEGBwAAAAAAAAECAwQFAAYREhORBxQhUlQxQVFic5KxJDJCYYGC0f/aAAgBAQABPwCFHnjWUzuvN6hV4cANSRLGjO9yRVUcSzMoA7jVXJYe5N0a2dhmk9kc0bN2GvLN8mbuNeWb5M3ca8s3yZu415Y/Jm7jXlm+TN3H/NeVPyZu40vOk3TZywK8wJ+v3EHVM/wsI/Dq2lrxN3Nnca16eti8chSAIoMbzByhMwP14kHVfwIiSaF5c96J6kwwCOTnHsYk8uvCrdmQy1TI4rJuz3cZLyGR/wCd4+YoOf8AEpUjXitubLYPG4paFsUxcuiGe7yc5gTW3LW44szXmobsi3Dhmic2+Z4+vCVH9CpraPiQ+QvbgTJrPFBWd5YpWrmNIIEXiRO32Pqt4p7cnfHk18lFBdmEVW1LVdIZGOrniTt6plrWKaO69yCykDRxwF+LMAewB0Txtr+Sf31VI8tEPw62fZt7N3Humtbpzz13ucX6CGSWMSuzpLyD1eNgeUka3PuvHbaxq3biTMHfkiSNCS78CwU+3Xg7Vu3MhuTcU6cq3Zemn3Eh2dv8Lzcut+29x1atKbHYqLJUhLwyNMwiZ3j9yDWOxUOV3tgb+3No5LDx1pi9+aeIwRlNY6bc+Jv+IFGrhLxtXJZ7VKcw81diiAAEn0JOrkWZyNfbEr0tz27UGQgkuGzXdIIvyowq99bRxk9ffO/L81SZBPZgEEroQroIxxMZOgeNsfkn99QypHGqO4Vl9CDrN4LDZkwyzyyQ2IgRHZrzGCZVP1XnQglT9oOtw4LC7iqV6uRkZoYpxKFSQpzFRw4EjVRMfSrQ1qqwxQxKFjjTgFUD7BoWYR6iVe+mtxt9Zwf9teaj4AdccPu5tedX5A/VrzUR+sy/q1CwksF19VEfDj/cnQRW+qg66cfsXtrpx+xe2unH7F7a6cfsXtrpx+xe2unH7F7a6cfsXtoxx+xe2gAAOA1//8QAFBEBAAAAAAAAAAAAAAAAAAAAMP/aAAgBAgEBPwB//8QAFBEBAAAAAAAAAAAAAAAAAAAAMP/aAAgBAwEBPwB//9k="
                    alt="Github Star">
            </a>
        </small>
    </p>
    <!-- 
    <p>
        <small>
            <span id="busuanzi_container_site_pv">👁<span id="busuanzi_value_site_pv"></span></span> &nbsp;
            <span id="busuanzi_container_page_pv">📚<span id="busuanzi_value_page_pv"></span></span>
        </small>
    </p>
    
     -->

</footer>


<script>
    window.addEventListener('load', function () {
        globalAddScript('//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js');
    })
</script>

<!-- Baidu Tongji -->





    <script>
        // 非本站网址，新开tab页签
        (function () {
            var stopBubble = function (e) {
                e && e.stopPropagation && e.stopPropagation();
            }
            var links = document.querySelectorAll('a');
            [].slice.call(links).forEach(function (item) {
                if (item.href && item.href.indexOf(window.location.host) === -1) {
                    item.target = '_blank'
                }
                // 阻止冒泡，不触发彩蛋。
                item.addEventListener('click', stopBubble, false);
            });
            var article = document.querySelector('article');
            article && article.addEventListener('click', stopBubble, false)
        })();
    </script>
    
</body>

</html>